### 客户订单跟踪

在查询出系统订单信息后，但是还有其他信息要补充；

- 星标
- 运输订单的信息
- 异常
- 客户信息

把这些查询出来的信息放在map集合中，后面根据map的key值获取这些对象，然后设置到客户订单跟踪集合中。

- 时间

  A 客户订单时间：在客户订单对应的运输订单中、取最早的时间值为客户订单时间。

  B 预约提货时间：在客户订单对应的运输订单中、取最早的时间值为预约提货时间。

  C 约送货时间：在客户订单对应的运输订单中、取最晚的时间值为预约送货时间。

  D 计划发货时间：在客户订单对应的运输订单中、取最早的时间值为计划发货时间。

  E 预约送货时间：在客户订单对应的运输订单中、取最晚的时间值为计划到达时间。

  F 到达时间：在客户订单对应的运输订单中、当最后一个运输订单确认到达（即最晚确认到达的）时取值。

  G 签收时间：在客户订单对应的运输订单中、当最后一个运输订单确认签收（即最晚确认签收的）时取值。

采用DateUtils中的afterDate()方法和beforeDate()，依次把客户订单对应的运输订单集合拿出来比较后就可以设置其值了。

对于**签收时间**，比较特别；采用流式处理，找出日期最大值，作为签收时间

- 订单状态：

  A 已创建：当客户订单对应的第一个系统订单生成，为已创建。

  B 在途：在客户订单对应的运输订单中、当最后一个运输订单确认离库（即最晚确认离库的），为在途。

  C 已签收：在客户订单对应的运输订单中、当最后一个运输订单确认签收（即最晚确认签收的），为已签收。

  D 已评价：当客户订单满意度有值时，为已评价。

先把所有的运输订单状态都放在一个集合中，采用if语句判断，如果状态集合中包含创建状态，则设置为创建；不是则判断其是否包含在途状态，有则设置为在途，以此类推。

- 签收状态：在客户订单对应的运输订单中，全部为完美签收CR，取值为完美签收；全部为拒收，取值为拒收RJ；只要有其中一个为不完美签收或拒收，取值为不完美签收PR

采用排除法，先判断其中两个类型（CR和PR）是否存在，没有则都为为RJ；再判断其中两个类型（RJ和PR）是否存在，没有则都为CR，有则为PR.

### 订单跟踪

1.利润中心编码/名称等某些属性，直接采用StringUtils的convertStringToBatchQuery()方法把值变为便于批量查询的字符串（以|分隔）

2.通过判断参数是否有运单来设置relationWaybill为true,通过它到sql中连接tb_waybill_order_relation表,如果有司机的相关属性,也设置relationWaybill为true,除了链接tb_waybill_order_relation还需要再通过它链接运单表甚至司机表,这些连接表只是用来做限制的,并没有获取其属性

这些其他属性值,在查询出运输订单数据后,再通过它再去获取,比如



3.判断用户项目和组织的权限：checkUsetAuthOfRegionAndIterm(userRoleVo, orderQueryVo);

这里的判断用户组织和项目的原因是查询参数包括所属组织和项目；只需要判断一种情况：当前用户下有组织/项目，然后跟参数的组织/项目做并集操作后为空，则抛出异常；其他情况，比如用户下没有组织或项目做并集操作后不为空，不做判断；



4.分用户类型查询

都要把参数和当前用户的参数做并集处理.

> 各种类型用户共有的权限限制：区域（组织）和项目、装卸点

不同用户类型需要区别其权限

- 承运商用户:承运商

- 运营商用户(外运用户):(没有)

- 客户用户:所属客户

5.ItemInfo是项目信息，有一个专门的表来存放订单的项目信息表

queryDetailBaseConfig是用来干嘛的?

6.自定义列表如何呈现

7.订单的事件信息，需要对事件的时间进行设置，把时间拆分为日期和时间；

8.扩展属性也是使用map集合来封装，先查出扩展属性:extendFieldConfigManager.getExtendFieldConfigMapOfTable()，再查询扩展属性的值:extendFieldManager.getExtendFieldByRelationIdList。

9.查询全部合计或当页合计时，当页合计由前台处理；全部合计由后台处理，后台先查出全部合计后返回（只有合计数据而已）再去调用同一接口查询当前页合计

### 运单跟踪

1.预配置是分配车辆？

2.判断司机号码是用regexp的方式查询，还是用In的方式处理--什么时候会使用到？

3.订单和运单都有相对应的项目信息可获取，存在于运单-订单关联表（tb_waybill_order_relation）中

4.

### 扩展字段配置

扩展表：order-订单,orderDetail-订单明细,way-运单,payFee-应付费用，recFee-应收费用,payBill-应付账单

### 异常

异常需要通过联结订单表、运单表、运单（订单）事件表、异常审核表四张表来查询出来，因为一般的订单号有可能有异常；而由订单产生的运单也可能有异常。

> 运单也有异常表，但是客户订单跟踪确实使用异常审核表来查询异常信息。为什么？

异常信息查询出来后，还需要对异常环节和附件进行重新查询后设置。

### 轨迹

查询轨迹的时候，一般还需查询最新的轨迹节点gpsInfoManager.getlatestGpsByTrqId(item)，看是取最新的轨迹节点，还是通过运输订单号去获取。查询轨迹需要查询出目的地集合、始发地集合、坐标、原始gps集合、节点轨迹gps集合

轨迹存在于运输订单中，通过调用gpsInfoManager.getGpsOptimizationByTrqId()可获得轨迹，通过gpsType判断使用哪种接口的轨迹（百度、高德等）；但是轨迹没有始发地和目的地，还需gpsInfoManager.getOrderLocInfoOfOrder(trqIdList)方法来获取始发地和目的地的；

### 回单

统一调用queryPhotoListBySign接口

### 节点管理

节点通过订单号来查询，统一调用getOrderEventCode接口

### 消息

需要用户、关联类型和关联id为参数，同意调用queryGlobalRemarkPage接口

## 物料

物料有对应的类MaterialModel，用来存放物料详情，运输订单和系统订单也有对应的物料，他们跟MaterialModel的关联是这些订单内的物料是物料的数量、单位、和其他属性，它绑定物料表的MaterialId
